# 🔧 修复端口不匹配问题

## 🚨 问题根源

从服务日志看：
```
INFO:     Uvicorn running on http://0.0.0.0:8000
```

但Zeabur配置的容器端口是：**8080**

**问题：**
- 应用监听在 **8000** 端口
- Zeabur的负载均衡器期望在 **8080** 端口找到服务
- 无法连接，返回 **502错误**

## ✅ 解决方案

### 方案1：添加PORT环境变量（推荐）⭐

**步骤：**

1. **在Zeabur控制台**
   - 访问：https://zeabur.com
   - 找到项目：my-telegram-bot33
   - 点击应用服务

2. **打开环境变量设置**
   - 找到 **"Settings"** → **"Environment Variables"**
   - 点击 **"Add Variable"** 或 **"添加变量"**

3. **添加PORT环境变量**
   - 变量名：`PORT`
   - 变量值：`8080`
   - 点击保存

4. **重启服务**
   - 找到 **"Restart"** 或 **"重启"** 按钮
   - 点击重启
   - 等待1-2分钟

5. **验证**
   - 查看服务日志
   - 应该看到：`INFO:     Uvicorn running on http://0.0.0.0:8080`
   - 运行检查脚本：`python scripts/tools/check_zeabur_deployment.py`

### 方案2：修改容器端口配置

**步骤：**

1. **在Zeabur服务设置中**
   - 找到端口配置
   - 将容器端口改为 `8000`
   - 将公开端口改为 `8000`

2. **保存并重启服务**

3. **验证**
   - 查看服务日志
   - 应该看到：`INFO:     Uvicorn running on http://0.0.0.0:8000`
   - 运行检查脚本

**注意：** 推荐使用方案1，因为Zeabur通常使用8080端口。

## 🔍 为什么会出现这个问题？

### 原因分析

1. **应用默认端口是8000**
   - 在代码中：`port: int = Field(8000, env="PORT")`
   - 如果没有 `PORT` 环境变量，使用默认值8000

2. **Zeabur配置的容器端口是8080**
   - Zeabur可能没有自动设置 `PORT` 环境变量
   - 或 `PORT` 环境变量未正确传递

3. **端口不匹配**
   - 应用监听在8000
   - 负载均衡器期望在8080
   - 无法连接

## 📋 检查清单

配置完成后，检查以下项目：

- [ ] `PORT` 环境变量已设置为 `8080`
- [ ] 服务已重启
- [ ] 日志显示：`Uvicorn running on http://0.0.0.0:8080`
- [ ] 运行检查脚本，所有端点返回200
- [ ] 可以访问：`https://my-telegram-bot33.zeabur.app/health/simple`

## 🧪 验证步骤

### 步骤1：检查环境变量

在Zeabur控制台，确认 `PORT=8080` 已设置。

### 步骤2：查看服务日志

重启后，查看日志：

**应该看到：**
```
INFO:     Uvicorn running on http://0.0.0.0:8080
```

**如果还是看到：**
```
INFO:     Uvicorn running on http://0.0.0.0:8000
```

说明 `PORT` 环境变量未生效，需要：
1. 确认环境变量已保存
2. 确认服务已重启
3. 或尝试方案2（修改容器端口）

### 步骤3：运行检查脚本

```bash
python scripts/tools/check_zeabur_deployment.py
```

**应该看到：**
- ✅ 所有端点返回200
- ✅ 服务可以正常访问

## 🆘 如果问题仍然存在

### 问题1：PORT环境变量设置了但应用还是监听8000

**可能原因：**
- 环境变量未正确传递
- 服务未重启

**解决：**
1. 确认环境变量已保存
2. 强制重启服务
3. 查看日志确认端口

### 问题2：修改容器端口后还是502

**可能原因：**
- 端口配置未生效
- 服务未重启

**解决：**
1. 确认端口配置已保存
2. 重启服务
3. 查看日志确认端口

## 📚 相关文档

- [端口配置指南](FIX_PORT_CONFIGURATION.md)
- [502错误排查步骤](502_TROUBLESHOOTING_STEPS.md)
- [服务启动成功指南](SERVICE_STARTED_SUCCESS.md)

## 🎯 立即操作

**现在就去做：**

1. ✅ 在Zeabur控制台，添加 `PORT=8080` 环境变量
2. ✅ 保存并重启服务
3. ✅ 查看日志，确认应用监听在8080端口
4. ✅ 运行检查脚本验证

配置完成后告诉我，我会帮您验证是否一切正常！




