# 🔄 环境变量设置后强制重启服务

## 🚨 问题说明

环境变量已配置，但服务没有自动重启，导致：
- 环境变量未生效
- 服务仍使用旧配置
- 可能仍然502错误

## ✅ 解决方案

### 方法1：在Zeabur控制台重启服务（推荐）⭐

**步骤：**

1. **访问Zeabur控制台**
   - 打开：https://zeabur.com
   - 登录您的账号
   - 找到项目：my-telegram-bot33

2. **打开应用服务**
   - 点击应用服务（不是PostgreSQL服务）
   - 进入服务详情页

3. **找到重启按钮**
   - 在服务页面顶部工具栏
   - 查找 **"Restart"** 或 **"重启"** 按钮
   - 或在 **"Actions"** 菜单中

4. **点击重启**
   - 点击 **"Restart"** 按钮
   - 如果有确认对话框，点击确认
   - 等待服务重启（1-2分钟）

5. **验证**
   - 查看服务状态，应该变为 "Restarting" 然后 "Running"
   - 查看服务日志，确认应用已重新启动
   - 应该看到：`INFO:     Uvicorn running on http://0.0.0.0:8080`

### 方法2：重新部署服务

**步骤：**

1. **在应用服务页面**
   - 找到 **"Redeploy"** 或 **"重新部署"** 按钮
   - 或在 **"Deployments"** 标签中

2. **触发重新部署**
   - 点击 **"Redeploy"** 按钮
   - 等待部署完成（3-5分钟）

3. **验证**
   - 查看部署状态
   - 查看服务日志

### 方法3：修改环境变量触发重启

**步骤：**

1. **在环境变量设置中**
   - 找到任意一个环境变量（例如 `DEBUG=false`）
   - 修改它（例如改为 `DEBUG= false`，加个空格）
   - 保存

2. **这会触发服务自动重启**
   - 等待服务重启（1-2分钟）

3. **改回原值**
   - 将环境变量改回正确值
   - 保存（会再次触发重启）

**注意：** 这个方法会触发两次重启，不推荐，但可以作为最后手段。

## 🔍 验证服务已重启

### 检查1：查看服务状态

在服务页面，查看状态指示器：

- 🟡 **Restarting** - 正在重启
- 🟡 **Building** - 正在构建
- 🟢 **Running** - 服务运行中

### 检查2：查看服务日志

在服务页面，找到 **"Logs"** 标签，查看最新的日志：

**应该看到新的启动日志：**
```
INFO:     Started server process [1]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080
```

**关键：** 确认端口是 **8080**，不是 8000！

### 检查3：运行检查脚本

等待服务完全启动后（1-2分钟），运行：

```bash
python scripts/tools/check_zeabur_deployment.py
```

**应该看到：**
- ✅ 所有端点返回200
- ✅ 服务可以正常访问

## ⚠️ 常见问题

### Q1: 找不到重启按钮？

**可能位置：**
- 服务页面顶部工具栏
- **"Actions"** 或 **"操作"** 菜单
- **"Settings"** → **"Restart"** 选项

**或使用：**
- 重新部署功能（"Redeploy"）

### Q2: 重启后日志还是显示8000端口？

**可能原因：**
- `PORT` 环境变量未正确设置
- 环境变量未正确传递

**解决：**
1. 确认 `PORT=8080` 环境变量已保存
2. 刷新页面查看环境变量
3. 再次重启服务

### Q3: 重启后还是502错误？

**可能原因：**
- 服务还在启动中（等待1-2分钟）
- 其他配置问题

**解决：**
1. 等待服务完全启动
2. 查看服务日志，查找错误信息
3. 运行检查脚本验证

## 📋 完整重启流程

### 推荐流程

1. ✅ **配置所有环境变量**
   - 在Zeabur控制台，添加所有必需的环境变量
   - 包括 `PORT=8080`
   - 保存配置

2. ✅ **手动触发重启**
   - 点击 **"Restart"** 按钮
   - 或使用 **"Redeploy"** 功能

3. ✅ **等待服务重启**
   - 等待1-2分钟（或3-5分钟如果重新部署）
   - 查看服务状态变为 "Running"

4. ✅ **验证配置**
   - 查看服务日志，确认端口是8080
   - 运行检查脚本验证服务可访问

## 🆘 如果问题仍然存在

请提供：

1. **服务状态**（Running/Building/Failed）
2. **最新的服务日志**（特别是启动日志）
3. **PORT环境变量是否已设置**（是/否）
4. **日志显示的端口**（8000还是8080）

## 📚 相关文档

- [手动重启服务](MANUAL_RESTART_SERVICE.md)
- [端口配置修复](FIX_PORT_MISMATCH.md)
- [环境变量配置](ZEABUR_ENV_VARS.md)

## 🎯 立即操作

**现在就去做：**

1. ✅ 在Zeabur控制台，找到 **"Restart"** 按钮
2. ✅ 点击重启
3. ✅ 等待1-2分钟
4. ✅ 查看日志，确认应用监听在8080端口
5. ✅ 运行检查脚本验证

重启完成后告诉我，我会帮您验证是否一切正常！




