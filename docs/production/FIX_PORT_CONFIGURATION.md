# 🔧 修复端口配置问题

## 🚨 问题说明

从您提供的Zeabur配置信息看：
- **容器端口**: HTTP:8080
- **公开端口**: HTTP:8080

但我们的应用配置：
- **默认端口**: 8000（在代码中）
- **使用环境变量**: `$PORT`（Zeabur会自动设置）

## ✅ 解决方案

### 方案1：确认Zeabur自动设置PORT环境变量（推荐）

Zeabur应该会自动设置 `PORT` 环境变量为8080，应用会使用这个值。

**检查方法：**
1. 在Zeabur控制台，打开应用服务设置
2. 查看环境变量列表
3. 确认 `PORT` 环境变量已存在，值为 `8080`

**如果PORT环境变量不存在：**
- 手动添加：`PORT=8080`
- 保存并重启服务

### 方案2：修改容器端口配置（如果方案1不行）

在Zeabur服务设置中：

1. **找到端口配置**
   - 在服务设置页面
   - 找到 "Port" 或 "端口" 配置

2. **修改容器端口**
   - 将容器端口改为 `8000`
   - 或保持 `8080`，但确保应用使用 `$PORT` 环境变量

3. **保存并重启服务**

## 🔍 检查当前配置

### 检查1：Procfile配置

**当前配置：**
```
web: uvicorn src.main:app --host 0.0.0.0 --port $PORT
```

✅ 这个配置是正确的，使用了 `$PORT` 环境变量。

### 检查2：zeabur.json配置

**当前配置：**
```json
{
  "deploy": {
    "startCommand": "uvicorn src.main:app --host 0.0.0.0 --port $PORT"
  }
}
```

✅ 这个配置也是正确的。

### 检查3：应用代码配置

**当前配置：**
```python
port: int = Field(8000, env="PORT")
```

✅ 这个配置会优先使用 `PORT` 环境变量，如果没有则使用默认值8000。

## 🛠️ 立即操作步骤

### 步骤1：检查PORT环境变量

在Zeabur控制台：

1. 访问：**https://zeabur.com**
2. 找到项目：**my-telegram-bot33**
3. 点击应用服务
4. 找到 **"Settings"** → **"Environment Variables"**
5. 查找 `PORT` 环境变量

**应该看到：**
- 变量名：`PORT`
- 变量值：`8080`（或Zeabur设置的其他值）

**如果没有：**
- 手动添加：`PORT=8080`
- 保存并重启服务

### 步骤2：确认端口映射

在Zeabur服务设置中：

1. **找到端口配置**
   - 确认容器端口是 `8080`
   - 确认公开端口是 `8080`

2. **如果容器端口不是8080**
   - 修改为 `8080`
   - 或修改为应用实际监听的端口

### 步骤3：重启服务

1. 在Zeabur控制台，找到 **"Restart"** 按钮
2. 点击重启
3. 等待1-2分钟
4. 再次运行检查脚本

## 📋 端口配置检查清单

- [ ] `PORT` 环境变量已设置（值为8080）
- [ ] `Procfile` 使用 `$PORT` 环境变量
- [ ] `zeabur.json` 使用 `$PORT` 环境变量
- [ ] 容器端口配置为 `8080`
- [ ] 公开端口配置为 `8080`
- [ ] 服务已重启

## 🧪 测试端口配置

重启服务后，查看服务日志：

**应该看到：**
```
INFO:     Uvicorn running on http://0.0.0.0:8080
```

**如果看到：**
```
INFO:     Uvicorn running on http://0.0.0.0:8000
```

说明 `PORT` 环境变量未生效，需要检查环境变量配置。

## 🆘 如果问题仍然存在

### 问题1：PORT环境变量未设置

**解决：**
1. 在Zeabur控制台，手动添加 `PORT=8080` 环境变量
2. 保存并重启服务

### 问题2：端口映射不正确

**解决：**
1. 在Zeabur服务设置中，确认容器端口和公开端口一致
2. 如果应用监听在8000，将容器端口改为8000
3. 如果容器端口是8080，确保应用使用 `$PORT` 环境变量

### 问题3：服务仍然502

**排查：**
1. 查看服务日志，确认应用监听的端口
2. 检查端口映射配置
3. 确认服务状态是 "Running"

## 📚 相关文档

- [502错误排查步骤](502_TROUBLESHOOTING_STEPS.md)
- [服务启动成功指南](SERVICE_STARTED_SUCCESS.md)
- [Zeabur部署检查清单](ZEABUR_CHECKLIST.md)




