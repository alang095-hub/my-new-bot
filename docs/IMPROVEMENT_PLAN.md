# AI自动回复系统改进实施计划

## 一、监控和告警改进

### 1.1 API调用量监控

**目标**: 跟踪OpenAI和Facebook API的调用次数、成本、响应时间

**实现方案**:
- 创建 `src/monitoring/api_usage_tracker.py`
- 记录每次API调用的详细信息：
  - API类型（OpenAI/Facebook）
  - 调用时间
  - 响应时间
  - 是否成功
  - 错误信息（如有）
  - 成本估算（OpenAI按token计算）
- 提供统计接口：
  - 今日/本周/本月调用量
  - 成功率
  - 平均响应时间
  - 成本统计

**数据库模型**:
- 创建 `api_usage_logs` 表记录每次调用
- 创建 `api_usage_statistics` 表记录每日统计

### 1.2 回复质量评估

**目标**: 自动评估AI回复的质量

**评估指标**:
- 回复长度（是否在合理范围内）
- 回复相关性（与用户问题的匹配度）
- 情感倾向（是否友好、专业）
- 是否包含必要信息（如Telegram链接）
- 语法和拼写检查

**实现方案**:
- 创建 `src/monitoring/reply_quality_evaluator.py`
- 使用简单的规则引擎评估：
  - 长度检查
  - 关键词匹配
  - 情感分析（可选，使用简单规则）

### 1.3 错误率告警

**目标**: 监控系统错误率并发送告警

**告警规则**:
- API错误率 > 10% → WARNING
- API错误率 > 20% → ERROR
- 回复生成失败率 > 5% → WARNING
- 回复生成失败率 > 10% → ERROR
- OpenAI API配额不足 → CRITICAL

**实现方案**:
- 扩展 `src/monitoring/alerts.py`
- 添加错误率计算逻辑
- 集成到现有告警系统

## 二、性能优化

### 2.1 批量处理未回复消息

**目标**: 优化调度器性能，支持批量处理

**实现方案**:
- 修改 `src/auto_reply/auto_reply_scheduler.py`
- 批量查询未回复消息（一次查询多条）
- 批量生成回复（使用asyncio.gather）
- 批量发送消息（控制并发数）

**优化点**:
- 减少数据库查询次数
- 提高并发处理能力
- 降低API调用延迟

### 2.2 数据库查询优化

**目标**: 优化数据库查询性能

**优化措施**:
- 添加必要的索引：
  - `conversations.ai_replied, conversations.received_at`
  - `conversations.platform_message_id`
  - `customers.platform_user_id`
- 使用批量查询替代循环查询
- 优化统计查询（使用聚合函数）

**实现方案**:
- 创建数据库迁移文件添加索引
- 优化Repository查询方法
- 使用select_related减少N+1查询

### 2.3 缓存机制

**目标**: 减少重复计算和数据库查询

**缓存策略**:
- 对话历史缓存（TTL: 5分钟）
- 客户信息缓存（TTL: 10分钟）
- 配置缓存（TTL: 1小时）
- 提示词模板缓存（TTL: 1小时）

**实现方案**:
- 创建 `src/core/cache/` 模块
- 使用内存缓存（Python dict + TTL）
- 提供缓存装饰器
- 集成到关键模块

## 三、用户体验改进

### 3.1 回复模板自定义

**目标**: 支持通过API动态配置回复模板

**功能**:
- 创建/更新/删除回复模板
- 模板分类管理
- 模板变量替换
- 模板预览和测试

**实现方案**:
- 创建 `src/api/v1/admin/templates.py` API
- 创建 `src/core/templates/manager.py` 模板管理器
- 支持YAML配置和API配置两种方式

### 3.2 A/B测试不同提示词

**目标**: 支持测试不同提示词版本的效果

**功能**:
- 创建提示词版本
- 随机分配用户到不同版本
- 对比不同版本的效果（回复质量、用户满意度）
- 统计分析结果

**实现方案**:
- 创建 `src/ai/prompt_ab_testing.py`
- 创建数据库模型存储测试配置和结果
- 在回复生成时选择提示词版本
- 记录使用情况用于分析

### 3.3 回复质量评分机制 ❌ (已取消)

**状态**: 根据用户要求，此功能已取消。

## 实施优先级

### 第一阶段（核心功能）
1. API调用量监控
2. 错误率告警
3. 批量处理优化
4. 数据库查询优化

### 第二阶段（性能提升）
5. 缓存机制
6. 回复质量评估

### 第三阶段（用户体验）
7. 回复模板自定义
8. A/B测试

## 实施步骤

1. 创建数据库迁移（添加新表和索引）
2. 实现核心监控功能
3. 优化性能瓶颈
4. 添加用户体验功能
5. 编写测试用例
6. 更新文档

