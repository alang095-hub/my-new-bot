# 生产环境测试检查清单

## 使用说明

本检查清单用于系统化地验证生产环境的各项功能。请按照阶段顺序执行测试，并在完成每项测试后勾选相应的复选框。

**测试日期：** ___________  
**测试人员：** ___________  
**测试环境：** ___________  
**测试版本：** ___________

---

## 阶段一：测试前准备

### 1.1 环境配置检查

- [ ] `.env` 文件已创建并配置
  - [ ] `DATABASE_URL` - 数据库连接字符串
  - [ ] `FACEBOOK_APP_ID` - Facebook应用ID
  - [ ] `FACEBOOK_APP_SECRET` - Facebook应用密钥
  - [ ] `FACEBOOK_ACCESS_TOKEN` - Facebook访问令牌
  - [ ] `FACEBOOK_VERIFY_TOKEN` - Facebook验证令牌
  - [ ] `OPENAI_API_KEY` - OpenAI API密钥
  - [ ] `TELEGRAM_BOT_TOKEN` - Telegram机器人令牌
  - [ ] `TELEGRAM_CHAT_ID` - Telegram聊天ID
  - [ ] `SECRET_KEY` - 应用密钥
  - [ ] `CORS_ORIGINS` - CORS允许的来源（生产环境）

- [ ] `config/config.yaml` 文件已创建并配置
  - [ ] 自动回复配置
  - [ ] 资料收集配置
  - [ ] 过滤规则配置
  - [ ] 页面设置
  - [ ] Telegram通知配置

**验证命令：**
```bash
python -c "from src.core.config import settings; print('✅ 配置加载成功')"
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 1.2 数据库迁移验证

- [ ] 数据库已创建
- [ ] 数据库用户已创建并授权
- [ ] 数据库连接测试通过
- [ ] 所有迁移文件已执行

**验证命令：**
```bash
alembic current
alembic upgrade head
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 1.3 API密钥验证

- [ ] Facebook API密钥有效
- [ ] OpenAI API密钥有效
- [ ] Telegram Bot令牌有效
- [ ] 所有API密钥权限正确

**验证命令：**
```bash
python scripts/tools/verify_api_keys.py
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 1.4 依赖安装验证

- [ ] 虚拟环境已创建
- [ ] 所有依赖已安装（`pip install -r requirements.txt`）
- [ ] 无依赖冲突

**验证命令：**
```bash
pip list | grep -E "(fastapi|sqlalchemy|openai|httpx)"
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

---

## 阶段二：环境验证测试

### 2.1 服务启动测试

- [ ] 服务可以正常启动
- [ ] 启动日志无错误
- [ ] 所有调度器已启动
  - [ ] Auto-reply scheduler started
  - [ ] Summary notification scheduler started

**验证命令：**
```bash
python run.py
# 或
uvicorn src.main:app --host 0.0.0.0 --port 8000
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 2.2 健康检查测试

- [ ] 健康检查端点返回200
- [ ] 返回JSON格式数据
- [ ] 所有健康检查项通过

**验证命令：**
```bash
curl http://localhost:8000/health
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 2.3 数据库连接测试

- [ ] 数据库连接成功
- [ ] 查询执行正常
- [ ] 连接池配置正确

**验证命令：**
```bash
python -c "from src.core.database.connection import engine; engine.connect(); print('✅ 数据库连接成功')"
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 2.4 配置加载测试

- [ ] 环境变量加载成功
- [ ] YAML配置加载成功
- [ ] 配置值正确

**验证命令：**
```bash
python -c "from src.core.config import settings, yaml_config; print('✅ 配置加载成功')"
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

---

## 阶段三：功能测试

### 3.1 Webhook接收测试

#### Facebook Webhook

- [ ] Webhook验证成功
- [ ] 消息接收成功
- [ ] 数据库记录创建
- [ ] 日志记录正确

**测试方法：**
1. 在Facebook页面上发送测试消息
2. 检查日志：`tail -f logs/app.log | grep "webhook"`
3. 检查数据库记录

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

#### Instagram Webhook（如果启用）

- [ ] Webhook验证成功
- [ ] 消息接收成功
- [ ] 数据库记录创建

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 3.2 AI自动回复测试

- [ ] AI回复生成成功
- [ ] 回复内容符合业务规则
- [ ] 回复已发送到用户
- [ ] 数据库记录更新

**测试方法：**
1. 发送包含产品关键词的测试消息
2. 等待AI回复（通常几秒内）
3. 检查回复内容和数据库记录

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 3.3 自动扫描调度器测试

- [ ] 调度器正常运行
- [ ] 未回复消息被检测到
- [ ] 消息被自动回复
- [ ] 日志记录正确

**测试方法：**
1. 创建未回复的消息（或等待5分钟）
2. 检查日志：`tail -f logs/app.log | grep "auto-reply"`
3. 验证消息是否被处理

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 3.4 Telegram通知测试

- [ ] 通知发送成功
- [ ] 通知内容正确
- [ ] 无发送错误

**测试方法：**
1. 触发通知事件
2. 检查Telegram群组是否收到消息

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 3.5 统计功能测试

- [ ] 统计API正常响应
- [ ] 统计数据准确
- [ ] 数据格式正确

**测试方法：**
```bash
curl http://localhost:8000/statistics/daily
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

---

## 阶段四：集成测试

### 4.1 端到端消息流程测试

- [ ] 消息接收成功
- [ ] 消息处理成功
- [ ] AI回复生成成功
- [ ] 回复发送成功
- [ ] 数据库记录正确
- [ ] Telegram通知正常（如果配置）

**测试方法：**
1. 发送完整测试消息
2. 验证整个流程
3. 检查所有步骤

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 4.2 多页面处理测试

- [ ] 所有页面配置正确
- [ ] 每个页面独立处理
- [ ] 无页面间干扰

**测试方法：**
1. 向不同页面发送消息
2. 验证每个页面都能正常处理

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 4.3 错误处理测试

- [ ] 错误被正确捕获
- [ ] 错误日志记录
- [ ] 系统继续运行
- [ ] 用户收到适当反馈

**测试场景：**
- API调用失败
- 数据库连接失败
- 无效消息格式
- 网络超时

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 4.4 速率限制测试

- [ ] 速率限制生效
- [ ] 无API限流错误
- [ ] 消息处理正常

**测试方法：**
1. 快速发送多条消息
2. 验证速率限制是否生效

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

---

## 阶段五：性能测试

### 5.1 响应时间测试

- [ ] 健康检查 < 100ms
- [ ] API响应 < 500ms
- [ ] AI回复生成 < 5s

**测试方法：**
```bash
time curl http://localhost:8000/health
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 5.2 并发处理测试

- [ ] 支持至少10个并发请求
- [ ] 无资源竞争
- [ ] 消息处理正确

**测试方法：**
```bash
python scripts/test/production_test.py --test concurrency
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 5.3 数据库查询性能测试

- [ ] 查询时间 < 1s（100条记录）
- [ ] 索引使用正确
- [ ] 无慢查询

**测试方法：**
```bash
python -c "
from src.core.database.connection import get_db
from src.core.database.models import Conversation
import time
db = next(get_db())
start = time.time()
result = db.query(Conversation).limit(100).all()
elapsed = time.time() - start
print(f'查询耗时: {elapsed:.3f}秒')
"
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 5.4 内存和CPU使用测试

- [ ] 内存使用稳定
- [ ] CPU使用正常
- [ ] 无资源泄漏

**测试方法：**
- Windows: `Get-Process python | Select-Object CPU, WorkingSet`
- Linux: `top -p $(pgrep -f "python.*main")`

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

---

## 阶段六：监控验证

### 6.1 日志输出验证

- [ ] 日志文件正常创建
- [ ] 日志级别正确
- [ ] 日志格式正确
- [ ] 日志轮转正常

**验证方法：**
```bash
ls -lh logs/app.log
tail -n 50 logs/app.log
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 6.2 监控指标验证

- [ ] 健康检查端点正常
- [ ] 性能指标端点正常
- [ ] 统计数据准确

**验证方法：**
```bash
curl http://localhost:8000/health
curl http://localhost:8000/metrics
curl http://localhost:8000/statistics/daily
```

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

### 6.3 告警机制验证

- [ ] 告警配置正确
- [ ] 告警触发及时
- [ ] 通知发送成功

**结果：** ☐ 通过  ☐ 失败  
**备注：** ___________

---

## 测试结果汇总

### 测试统计

- **总测试项：** ___________
- **通过项：** ___________
- **失败项：** ___________
- **跳过项：** ___________
- **通过率：** ___________%

### 关键测试结果

#### 必须通过的测试（阻塞性问题）

- [ ] 服务可以正常启动
- [ ] 数据库连接正常
- [ ] 健康检查通过
- [ ] Webhook接收正常
- [ ] AI自动回复功能正常
- [ ] 数据库记录正确
- [ ] 无严重错误日志

#### 建议通过的测试（非阻塞性）

- [ ] 性能指标正常
- [ ] 监控功能正常
- [ ] 统计功能正常
- [ ] Telegram通知正常
- [ ] 多页面处理正常

---

## 发现的问题

### 问题1

**描述：** ___________  
**严重程度：** ☐ 高  ☐ 中  ☐ 低  
**复现步骤：**  
1. ___________
2. ___________
3. ___________

**预期行为：** ___________  
**实际行为：** ___________  
**修复建议：** ___________

---

### 问题2

**描述：** ___________  
**严重程度：** ☐ 高  ☐ 中  ☐ 低  
**复现步骤：**  
1. ___________
2. ___________
3. ___________

**预期行为：** ___________  
**实际行为：** ___________  
**修复建议：** ___________

---

### 问题3

**描述：** ___________  
**严重程度：** ☐ 高  ☐ 中  ☐ 低  
**复现步骤：**  
1. ___________
2. ___________
3. ___________

**预期行为：** ___________  
**实际行为：** ___________  
**修复建议：** ___________

---

## 测试结论

### 总体评估

☐ **通过** - 所有关键测试通过，系统可以部署到生产环境  
☐ **有条件通过** - 部分非关键测试失败，但不影响核心功能  
☐ **失败** - 存在阻塞性问题，需要修复后重新测试

### 部署建议

**是否可以部署到生产环境？**

☐ 是 - 可以立即部署  
☐ 否 - 需要修复问题后再部署  
☐ 有条件 - 可以部署，但需要监控以下问题：___________

### 后续行动

1. ___________
2. ___________
3. ___________

---

## 测试人员签名

**测试人员：** ___________  
**日期：** ___________  
**签名：** ___________

---

## 审核人员签名

**审核人员：** ___________  
**日期：** ___________  
**签名：** ___________

---

## 备注

___________
___________
___________

---

**文档版本：** 1.0  
**最后更新：** 2025-01-XX

